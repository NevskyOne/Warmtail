using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.InputSystem;
using Data.House;
using Zenject;
using Systems;

namespace Entities.House
{
    public class DraggableObject : MonoBehaviour, IPointerDownHandler, IPointerUpHandler
    {
#region base
        [SerializeField] private GameObject _buttonsForConfirmed;
        [SerializeField] private GameObject _buttonsForEditing;
        [SerializeField] private GameObject _child;
        [SerializeField] private HouseItemData _houseItemData;
        private PlacementSystem _placementSystem;
        private InputAction _leftClickAction;
        private BoxCollider _boxCollider;
        private Vector2 _posObjectOnPointerDown;
        private Vector2 _posMouseOnPointerDown;
        private Vector2 _posObjectOnConfirmedState;
        private bool _isClickedNow;
        private bool _isPlacementing;
        private bool _isMenuEnabled;
        private bool _isConfirmed = true;
        private bool _isVisible = true;

        void Awake()
        {
            PlacementSystem.OnApplyedAll += ApplyEditing;
            PlacementSystem.OnCanceledAll += CancelEdited;
            
            _boxCollider = GetComponent<BoxCollider>();
        }
        void OnDestroy()
        {
            PlacementSystem.OnApplyedAll -= ApplyEditing;
            PlacementSystem.OnCanceledAll -= CancelEdited;
        }

        [Inject]
        private void Construct(PlacementSystem placementSystem, PlayerInput input)
        {
            _leftClickAction = input.actions.FindAction("LeftMouse");
            _placementSystem = placementSystem;
        }
        public void Initialize(bool isConfirmed)
        {
            _posObjectOnConfirmedState = (isConfirmed ? transform.position : Vector2.positiveInfinity);
            _isConfirmed = isConfirmed;
        }
#endregion
#region interaction
        private void Update()
        {
            if (_leftClickAction.WasReleasedThisFrame())
            {
                if (!_isClickedNow) DisableMenu();
                _isClickedNow = false;
            }
            if (_isPlacementing)
            {
                Vector2 v2 = Camera.main.ScreenToWorldPoint(Mouse.current.position.ReadValue());
                transform.position = _posObjectOnPointerDown + (v2 - _posMouseOnPointerDown);
            }
        }
        
        public void OnPointerDown(PointerEventData pointerEventData)
        {
            _isPlacementing = true;
            _posMouseOnPointerDown = Camera.main.ScreenToWorldPoint(Mouse.current.position.ReadValue());
            _posObjectOnPointerDown = transform.position;
            _isClickedNow = true; 
            EnableMenu();
        }
        public void OnPointerUp(PointerEventData pointerEventData)
        {
            Vector2 pos = transform.position;
            if (_posObjectOnConfirmedState != pos) {
                if (_isConfirmed) DisableMenu();
                _isConfirmed = false;
            }
            DisableMenu();
            EnableMenu();
            _isPlacementing = false;
        }
        private void DisableMenu()
        {
            if (!_isMenuEnabled) return;
            _isMenuEnabled = false;
            _buttonsForConfirmed.SetActive(false);
            _buttonsForEditing.SetActive(false);
        }
        private void EnableMenu()
        {
            if (_isMenuEnabled) return;
            _isMenuEnabled = true;
            if (_isConfirmed) _buttonsForConfirmed.SetActive(true);
            else _buttonsForEditing.SetActive(true);
        }
#endregion
#region buttons methods

        public void ApplyEditing()
        {
            if (_isConfirmed) return;
            if (!_isVisible) 
            {
                ApplyInventory(1);
                _placementSystem.RemoveEditingItem(_houseItemData.Id, _posObjectOnConfirmedState);
                Destroy(gameObject);
            }
            else
            {
                if (_posObjectOnConfirmedState.x == Vector2.positiveInfinity.x)
                {
                    ApplyInventory(-1);
                    _placementSystem.AddEditingItem(_houseItemData.Id, transform.position);
                }
                else _placementSystem.ReplacePositionEditingItem(_houseItemData.Id, _posObjectOnConfirmedState, transform.position);
                _posObjectOnConfirmedState = transform.position;
                _isConfirmed = true;
            }
        }
        public void CancelEdited()
        {
            if (_isConfirmed) return;
            if (_posObjectOnConfirmedState.x == Vector2.positiveInfinity.x) 
            {
                RemoveFromInventory();
                Destroy(gameObject);
            }
            else {
                if (!_isVisible) AddToInventory();
                _isConfirmed = true;
                transform.position = _posObjectOnConfirmedState;
                _child.SetActive(true);
                _boxCollider.enabled = true;
                _isVisible = true;
            }
        }
        public void RemoveObject()
        {
            _isConfirmed = false;
            _child.SetActive(false);
            _boxCollider.enabled = false;
            _isVisible = false;
            RemoveFromInventory();
        }

        private void ApplyInventory(int how) => _placementSystem.ApplyItemInventory(_houseItemData.Id, how);
        public void AddToInventory() => _placementSystem.AddItemToInventory(_houseItemData.Id);
        public void RemoveFromInventory() => _placementSystem.RemoveItemFromInventory(_houseItemData.Id);
    }
#endregion
}
