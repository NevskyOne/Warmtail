using System;
using System.Threading;
using Cysharp.Threading.Tasks;
using Data;
using Data.Player;
using UnityEngine;
using Zenject;

namespace Systems
{

    public class WarmthSystem
    {
        private const int WarmthIncreaseRate = 1;
        private const float IncreaseIntervalSeconds = 1f;
        private const float CooldownSeconds = 3f;

        private GlobalData _globalData;

        private ResettableTimer _cooldownTimer;
        private CancellationTokenSource _increaseCts;
        private bool _isIncreasing;

        [Inject]
        private void Construct(GlobalData globalData)
        {
            _globalData = globalData;
            _globalData.Edit<RuntimePlayerData>(data =>
            {
                data.CurrentWarmth = _globalData.Get<SavablePlayerData>().Stars * 10;
            });
            _globalData.SubscribeTo<SavablePlayerData>(StartIncreaseIfNotRunning);
        }

        public void DecreaseWarmth(int value)
        {
            _globalData.Edit<RuntimePlayerData>(data =>
            {
                data.CurrentWarmth = Mathf.Max(data.CurrentWarmth - value, 0);
            });

            if (_increaseCts != null)
            {
                _increaseCts.Cancel();
                _increaseCts.Dispose();
                _increaseCts = null;
                _isIncreasing = false;
            }

            if (_cooldownTimer == null)
            {
                _cooldownTimer = new ResettableTimer(CooldownSeconds, StartIncreaseIfNotRunning);
                _cooldownTimer.Start();
            }
            else
            {
                _cooldownTimer.Reset(CooldownSeconds);
            }
        }

        private void StartIncreaseIfNotRunning()
        {
            if (_isIncreasing) return;
            _isIncreasing = true;
            _increaseCts?.Dispose();
            _increaseCts = new CancellationTokenSource();
            RunIncreaseAsync(_increaseCts.Token).Forget();
        }

        private async UniTaskVoid RunIncreaseAsync(System.Threading.CancellationToken token)
        {
            try
            {
                while (true)
                {
                    token.ThrowIfCancellationRequested();

                    var max = _globalData.Get<SavablePlayerData>().Stars * 10;
                    var current = _globalData.Get<RuntimePlayerData>().CurrentWarmth;

                    if (current >= max) break;

                    _globalData.Edit<RuntimePlayerData>(data =>
                    {
                        var newVal = Mathf.Min(data.CurrentWarmth + WarmthIncreaseRate, max);
                        data.CurrentWarmth = newVal;
                    });

                    await UniTask.Delay(TimeSpan.FromSeconds(IncreaseIntervalSeconds), cancellationToken: token);
                }
            }
            catch (OperationCanceledException) { }
            finally
            {
                _isIncreasing = false;
                if (_increaseCts != null)
                {
                    _increaseCts.Dispose();
                    _increaseCts = null;
                }
            }
        }
    }
}